server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # Application logs from mounted volume
  - job_name: fastify-app-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: fastify-telemetry-app
          service: fastify-telemetry-example
          environment: development
          __path__: /app/logs/*.log

    pipeline_stages:
      - json:
          expressions:
            level: level
            message: message
            timestamp: timestamp
            service: service
            traceId: traceId
            spanId: spanId
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      - labels:
          level:
          service:
          traceId:
          spanId:

  # Docker container logs
  - job_name: docker-containers
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: label
            values: ["logging=promtail"]

    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        target_label: 'container_name'
      - source_labels: ['__meta_docker_container_log_stream']
        target_label: 'logstream'
      - source_labels: ['__meta_docker_container_label_logging_jobname']
        target_label: 'job'

    pipeline_stages:
      - json:
          expressions:
            level: level
            service: service
            message: message
            timestamp: timestamp
            traceId: traceId
            spanId: spanId
      - timestamp:
          source: timestamp
          format: RFC3339Nano
          fallback_formats:
            - "2006-01-02T15:04:05.000000000Z07:00"
            - "2006-01-02T15:04:05.000Z07:00"
            - "2006-01-02T15:04:05Z07:00"
      - labels:
          level:
          service:
          traceId:
          spanId:

  # System logs (optional)
  - job_name: system-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: system
          __path__: /var/log/*.log

    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\S+\s+\S+\s+\S+)\s+(?P<level>\S+)\s+(?P<message>.*)$'
      - timestamp:
          source: timestamp
          format: 'Jan 02 15:04:05'
      - labels:
          level:

  # FastAPI/Node.js application structured logs
  - job_name: structured-app-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: app-structured
          service: fastify-telemetry
          __path__: /app/logs/app.*.log

    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            service: service
            environment: environment
            traceId: traceId
            spanId: spanId
            userId: userId
            requestId: requestId
            duration: duration
            statusCode: statusCode
            method: method
            url: url
            userAgent: userAgent
            ip: ip

      - timestamp:
          source: timestamp
          format: RFC3339Nano

      - labels:
          level:
          service:
          environment:
          traceId:
          spanId:
          method:
          statusCode:

      # Extract metrics from logs
      - metrics:
          http_requests_total:
            type: Counter
            description: "Total number of HTTP requests"
            source: message
            config:
              value: "1"
              action: inc
          http_request_duration_seconds:
            type: Histogram
            description: "HTTP request duration in seconds"
            source: duration
            config:
              buckets: [0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5, 10]
